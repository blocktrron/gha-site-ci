#!/bin/bash

set -ef

# Determine Gluon Make args
GLUON_MAKE_ARGS=""
[ -n "$ACTION_AUTOREMOVE" ] && GLUON_MAKE_ARGS="${GLUON_MAKE_ARGS} GLUON_AUTOREMOVE=${ACTION_AUTOREMOVE}"
[ -n ""$ACTION_HARDWARE_TARGET ] && GLUON_MAKE_ARGS="${GLUON_MAKE_ARGS} GLUON_TARGET=${ACTION_HARDWARE_TARGET}"
[ -n "$GLUON_ACTION_BROKEN" ] && GLUON_MAKE_ARGS="${GLUON_MAKE_ARGS} BROKEN=${GLUON_ACTION_BROKEN}"
[ -n "$GLUON_ACTION_AUTOUPDATER_BRANCH" ] && GLUON_MAKE_ARGS="${GLUON_MAKE_ARGS} GLUON_AUTOUPDATER_BRANCH=${GLUON_ACTION_AUTOUPDATER_BRANCH}"
[ -n "$GLUON_ACTION_AUTOUPDATER_ENABLED" ] && GLUON_MAKE_ARGS="${GLUON_MAKE_ARGS} GLUON_AUTOUPDATER_ENABLED=${GLUON_ACTION_AUTOUPDATER_ENABLED}"
[ -n "$GLUON_ACTION_RELEASE" ] && GLUON_MAKE_ARGS="${GLUON_MAKE_ARGS} GLUON_RELEASE=${GLUON_ACTION_RELEASE}"
[ -n "$ACTION_PRIORITY" ] && GLUON_MAKE_ARGS="${GLUON_MAKE_ARGS} GLUON_PRIORITY=${ACTION_PRIORITY}"

echo "Extra args for build: ${GLUON_MAKE_ARGS}"

# Build
make -C /gluon/gluon-repo $ACTION_MAKE_TARGET $GLUON_MAKE_ARGS GLUON_SITEDIR=/gluon/site-repo V=s "-j$(nproc)"
echo "Build finished"
